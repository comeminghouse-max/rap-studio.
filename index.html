<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rap Studio Pro v51.1 - Cloud Master</title>
    <style>
        :root { --bg-beige: #e8e2d2; --light-reflect: #ffffff; --dark-shadow: #c5beb0; --text-main: #5d574a; --accent-warm: #c18c5d; --border-soft: rgba(255, 255, 255, 0.5); }
        body { font-family: 'Times New Roman', Times, serif; background-color: var(--bg-beige); color: var(--text-main); margin: 0; padding: 0; height: 100vh; display: flex; overflow: hidden; }
        .sidebar-left { width: 110px; background: var(--bg-beige); display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 40px 10px; border-right: 1px solid var(--border-soft); z-index: 1000; }
        .tab-btn { width: 80px; background: var(--bg-beige); color: var(--text-main); border: none; padding: 12px 5px; cursor: pointer; font-family: 'Times New Roman', serif; font-weight: bold; border-radius: 12px; box-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-reflect); opacity: 0.6; }
        .tab-btn.active { opacity: 1; color: var(--accent-warm); box-shadow: inset 4px 4px 8px var(--dark-shadow), inset -4px -4px 8px var(--light-reflect); }
        .account-section { margin-top: auto; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
        .login-btn { background: var(--bg-beige); color: #4285F4; border: none; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; box-shadow: 4px 4px 10px var(--dark-shadow), -4px -4px 10px var(--light-reflect); }
        .login-btn.online { color: #34A853; box-shadow: inset 2px 2px 5px var(--dark-shadow); }
        .user-status { font-size: 10px; font-weight: bold; text-transform: uppercase; opacity: 0.6; }

        /* Stealth Header & Fixed Controls Baseline v48.0 */
        .input-reveal-zone { position: fixed; top: 0; left: 110px; right: 230px; height: 100px; z-index: 500; display: flex; align-items: flex-start; }
        .music-input-stealth { width: 100%; display: flex; align-items: center; gap: 15px; background: var(--bg-beige); padding: 12px 25px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transform: translateY(calc(-100% + 8px)); transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1); will-change: transform; pointer-events: auto; }
        .input-reveal-zone:hover .music-input-stealth, .music-input-stealth.active { transform: translateY(0); box-shadow: 8px 8px 16px var(--dark-shadow); }
        input[type="text"] { flex: 1; text-align: center; background: var(--bg-beige); border: none; padding: 10px; border-radius: 12px; outline: none; box-shadow: inset 4px 4px 8px var(--dark-shadow), inset -4px -4px 8px var(--light-reflect); color: var(--text-main); font-family: 'Times New Roman', serif; }
        .btn-input { background: var(--bg-beige); color: var(--accent-warm); border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; box-shadow: 3px 3px 8px var(--dark-shadow), -3px -3px 8px var(--light-reflect); font-size: 11px; }

        .fixed-controls-row { display: flex; justify-content: flex-end; padding: 20px 20px 5px 0; }
        .capsule-group { display: flex; gap: 15px; background: var(--bg-beige); padding: 10px 20px; border-radius: 25px; box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-reflect); }
        .capsule-pill { width: 60px; height: 100px; background: var(--bg-beige); border-radius: 30px; box-shadow: 4px 4px 8px var(--dark-shadow), -4px -4px 8px var(--light-reflect); display: flex; flex-direction: column; align-items: center; padding: 6px 4px; position: relative; justify-content: space-between; }
        .pill-track { position: absolute; bottom: 22px; width: 34px; height: 45px; background: var(--bg-beige); border-radius: 15px; box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-reflect); overflow: hidden; pointer-events: none; }
        .pill-fill { width: 100%; height: 100%; background: var(--accent-warm); transform-origin: bottom; transform: scaleY(0.5); transition: transform 0.1s linear; will-change: transform; opacity: 0.7; }
        .hidden-range { position: absolute; width: 90px; height: 60px; top: 20px; transform: rotate(-90deg); opacity: 0; cursor: pointer; z-index: 5; }

        /* Main View Structure */
        .main-container { flex: 1; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; gap: 15px; position: relative; }
        .editor-layout { display: grid; grid-template-columns: 1fr 220px; gap: 20px; height: 45%; min-height: 250px; }
        .editor-container-block { background: var(--bg-beige); border-radius: 20px; padding: 10px; box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-reflect); display: flex; flex-direction: column; }
        textarea { background: var(--bg-beige) !important; border: none !important; color: var(--text-main); padding: 20px; font-size: 22px; border-radius: 15px; resize: none; outline: none !important; line-height: 1.7; font-family: 'Times New Roman', serif; box-shadow: inset 6px 6px 10px var(--dark-shadow), inset -6px -6px 10px var(--light-reflect) !important; flex-grow: 1; }
        .sidebar-right { background: var(--bg-beige); border-radius: 25px; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-reflect); }
        .count-val { font-size: 70px; font-weight: 900; color: var(--accent-warm); text-shadow: 1px 1px 2px var(--dark-shadow); }
        .note-section { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-beige); border-radius: 25px; padding: 15px; box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-reflect); overflow: hidden; gap: 10px; }
        .note-toolbar { display: flex; gap: 10px; padding: 10px; background: var(--bg-beige); border-radius: 15px; box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-reflect); justify-content: center; }
        #note-editor { flex: 1; outline: none; padding: 20px; overflow-y: auto; background: var(--bg-beige); border-radius: 15px; box-shadow: inset 4px 4px 8px var(--dark-shadow), inset -4px -4px 8px var(--light-reflect); }
        .hidden { display: none !important; }
        #flow-counts-sidebar { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; overflow-y: hidden; padding-top: 20px; }
        .flow-chip-wrapper { height: 52.8px; display: flex; align-items: center; justify-content: center; width: 100%; }
        .flow-number-chip { width: 60px; height: 35px; background: var(--bg-beige); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: var(--accent-warm); box-shadow: inset 3px 3px 6px var(--dark-shadow), inset -3px -3px 6px var(--light-reflect); text-shadow: 1px 1px 2px var(--dark-shadow); }
    </style>
</head>
<body>

    <div class="sidebar-left">
        <button class="tab-btn active" id="btnLyric" onclick="switchTab('lyric')">LYRIC</button>
        <button class="tab-btn" id="btnFlow" onclick="switchTab('flow')">FLOW</button>
        <div class="account-section">
            <span class="user-status" id="authStatus">Offline</span>
            <button class="login-btn" id="loginBtn" onclick="handleAuth()">G</button>
        </div>
    </div>

    <div class="input-reveal-zone" id="stealthZone">
        <div class="music-input-stealth" id="stealthBar">
            <input type="text" id="musicUrl" placeholder="Paste link or DROP file here...">
            <button class="btn-input" onclick="loadMusic()">LINK</button>
            <button class="btn-input" onclick="document.getElementById('fileInput').click()">FILE</button>
            <input type="file" id="fileInput" hidden accept="audio/*" onchange="handleFile(this.files[0])">
        </div>
    </div>

    <div class="main-container">
        <div class="fixed-controls-row">
            <div class="capsule-group">
                <div class="capsule-pill"><span class="pill-label">SPEED</span><div class="pill-track"><div id="speedFill" class="pill-fill"></div></div><span id="speedVal" class="pill-value">1.0x</span><input type="range" min="0.5" max="2" step="0.1" value="1" class="hidden-range" oninput="updateSpeedUI(this.value)"></div>
                <div class="capsule-pill"><span class="pill-label">VOL</span><div class="pill-track"><div id="volFill" class="pill-fill"></div></div><span id="volVal" class="pill-value">100%</span><input type="range" min="0" max="100" value="100" class="hidden-range" oninput="updateVolUI(this.value)"></div>
            </div>
        </div>

        <div id="lyric-view">
            <div class="editor-layout">
                <div class="editor-container-block"><textarea id="lyric-editor" placeholder="Write lyric here..." oninput="autoSave()"></textarea></div>
                <div class="sidebar-right">
                    <span class="stat-label">REMAINING</span>
                    <div id="result" class="count-val">10</div>
                    <input type="number" id="target" value="10" style="width:50px; background:transparent; border:none; text-align:center; color:var(--accent-warm); font-weight:bold;" oninput="autoSave()">
                </div>
            </div>
            <div class="note-section">
                <div class="note-toolbar">
                    <button style="border:none; background:none; cursor:pointer; font-weight:bold;" onclick="document.execCommand('bold')">B</button>
                    <button style="border:none; background:none; cursor:pointer; font-style:italic;" onclick="document.execCommand('italic')">I</button>
                </div>
                <div id="note-editor" contenteditable="true" oninput="autoSave()">Your notes here...</div>
            </div>
        </div>

        <div id="flow-view" class="hidden">
            <div class="editor-layout">
                <div class="editor-container-block"><textarea id="flow-editor" placeholder="Write flow here..." oninput="renderFlowCounts(); autoSave()" onscroll="syncScroll()"></textarea></div>
                <div class="sidebar-right"><div id="flow-counts-sidebar"><div id="flow-counts"></div></div></div>
            </div>
        </div>
        <audio id="aud" controls style="display:none; width:100%; margin-top:10px;"></audio>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const CLIENT_ID = "84269004246-gl2gvfsc0m8ql9kqraak3tliefltv9b2.apps.googleusercontent.com";
        let accessToken = null, hideTimeout;

        // --- GOOGLE DRIVE SYNC LOGIC ---
        function handleAuth() {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (tokenResponse) => {
                    if (tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        document.getElementById('authStatus').innerText = "Online";
                        document.getElementById('loginBtn').classList.add('online');
                        saveToDrive(); // Đồng bộ lần đầu khi login
                    }
                },
            });
            client.requestAccessToken();
        }

        async function saveToDrive() {
            if (!accessToken) return;
            const content = localStorage.getItem('rapStudioData');
            const metadata = { name: 'rap_studio_backup.json', mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: 'application/json' }));

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken },
                body: form
            }).then(res => console.log("Synced to Drive"));
        }

        // --- BASELINE v48.0 CORE LOGIC ---
        function autoSave() {
            const data = {
                lyric: document.getElementById('lyric-editor').value,
                flow: document.getElementById('flow-editor').value,
                note: document.getElementById('note-editor').innerHTML,
                target: document.getElementById('target').value
            };
            localStorage.setItem('rapStudioData', JSON.stringify(data));
            updateRemaining();
            if (accessToken) saveToDrive(); // Tự động đẩy lên Drive mỗi khi gõ
        }

        function loadLocal() {
            const s = localStorage.getItem('rapStudioData');
            if(s) {
                const d = JSON.parse(s);
                document.getElementById('lyric-editor').value = d.lyric||'';
                document.getElementById('flow-editor').value = d.flow||'';
                document.getElementById('note-editor').innerHTML = d.note||'';
                document.getElementById('target').value = d.target||10;
            }
            updateRemaining();
        }

        function startHide() { clearTimeout(hideTimeout); hideTimeout = setTimeout(() => { document.getElementById('stealthBar').classList.remove('active'); }, 5000); }
        document.getElementById('stealthZone').onmouseenter = () => { clearTimeout(hideTimeout); document.getElementById('stealthBar').classList.add('active'); };
        document.getElementById('stealthZone').onmouseleave = startHide;

        function updateSpeedUI(v) { document.getElementById('speedVal').innerText = v + 'x'; document.getElementById('speedFill').style.transform = `scaleY(${(v-0.5)/1.5})`; document.getElementById('aud').playbackRate = v; }
        function updateVolUI(v) { document.getElementById('volVal').innerText = v + '%'; document.getElementById('volFill').style.transform = `scaleY(${v/100})`; document.getElementById('aud').volume = v/100; }
        function getWords(t) { return t ? t.trim().split(/\s+/).filter(w => w.length > 0).length : 0; }
        function switchTab(t) {
            document.getElementById('lyric-view').classList.toggle('hidden', t!=='lyric');
            document.getElementById('flow-view').classList.toggle('hidden', t!=='flow');
            document.getElementById('btnLyric').classList.add('active'); document.getElementById('btnFlow').classList.remove('active');
            if(t==='flow') { renderFlowCounts(); document.getElementById('btnFlow').classList.add('active'); document.getElementById('btnLyric').classList.remove('active'); }
        }
        function renderFlowCounts() { const lines = document.getElementById('flow-editor').value.split('\n'); document.getElementById('flow-counts').innerHTML = lines.map(l => `<div class="flow-chip-wrapper"><div class="flow-number-chip">${getWords(l)||''}</div></div>`).join(''); }
        function syncScroll() { document.getElementById('flow-counts-sidebar').scrollTop = document.getElementById('flow-editor').scrollTop; }
        function updateRemaining() { const rem = document.getElementById('target').value - getWords(document.getElementById('lyric-editor').value); document.getElementById('result').innerText = rem; }
        function handleFile(f) { document.getElementById('aud').src = URL.createObjectURL(f); document.getElementById('aud').style.display='block'; document.getElementById('aud').play(); }
        
        window.onload = () => { loadLocal(); updateVolUI(100); updateSpeedUI(1.0); startHide(); };
    </script>
</body>
</html>